#!/usr/bin/env bash
# 2013, s.andres@syseleven.de
# 2014, s.doering@syseleven.de

# WARNING: This file is auto-generated by puppet!
# WARNING: To change it, edit the file in modules/ve_base/files/check_outgoing_ip

PATH=/sbin/:/usr/bin/:/bin/:$PATH

# get extern ips
e_ips=$(ip a | grep -w inet | sed 's:[ \t]\+inet ::g;s:\(^127\.\|^10\.\|/\).*::g;')

# has external ip(s)?
if [ -z "${e_ips}" ]; then
  printf "OK - no outgoing ip found on any interface\n"
  exit 0
fi

# get outgoing ip
if ! o_ip=$(curl --retry 2 --retry-delay 10 --connect-timeout 10 --max-time 30 -s ip.syseleven.de); then
  printf "WARNING - could not get ip from ip.syseleven.de\n"
  exit 1
fi

# trim outgoing ip
o_ip=${o_ip% }

# loop extern ips to check if one of those is in use
for ip in ${e_ips}; do
  if [ "${o_ip}" = "${ip}" ]; then
    printf "OK - %s found and used\n" "${ip}"
    exit 0
  fi
done

# return warning if no ip matches
printf "WARNING - %s (%s) not found on any interface\n" "${o_ip}" "$(host ${o_ip})"
exit 1


